```{r helper_meta,  include = F}
covariates_meta_analysis <- sort(params$covariates[which(!params$covariates %in% c("study_gxe", paste0(rep('pc', 20), seq(1, 20))))])

# helper function to create filename suffix 
create_suffix <- function(covar, strata = '') {
  if(strata == '') {
    paste0(paste0(covar, collapse = '_'), strata, "_all.png")
  } else {
    paste0(paste0(covar, collapse = '_'), "_", strata, ".png")
  }
}

# don't stratify by sex if exposure is HRT
if(params$exposure %in% c("hrt_ref_pm2", "eo_ref_pm_gxe", "ep_ref_pm_gxe", "pure_eo_allNo", "pure_ep_allNo")) {
  stratify_by_sex = F
} else {
  stratify_by_sex = T
}

# output dir
output_dir_meta <- glue("/media/work/gwis/posthoc/{params$exposure}/")
```


#### All
```{r  out.width="49%", echo = F, message = F, warning = F, cache = F}
all <- create_suffix(covariates_meta_analysis)

knitr::include_graphics(paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", all))
knitr::include_graphics(paste0(output_dir_meta, "funnel_plot_", params$exposure, "_", all))
```

#### Sex
```{r echo=F, out.width="49%", eval=stratify_by_sex}
covariates_meta_analysis_nosex <- covariates_meta_analysis[! covariates_meta_analysis %in% "sex"]
females <- create_suffix(covariates_meta_analysis_nosex, 'female')
males <- create_suffix(covariates_meta_analysis_nosex, 'male')

knitr::include_graphics(c(paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", females),
                          paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", males)))
knitr::include_graphics(c(paste0(output_dir_meta, "funnel_plot_", params$exposure, "_", females),
                          paste0(output_dir_meta, "funnel_plot_", params$exposure,  "_", males)))
```

<!-- #### Tumor Site -->
<!-- ```{r echo=F, out.width="49%"} -->
<!-- proximal <- create_suffix(covariates_meta_analysis, 'proximal') -->
<!-- distal <- create_suffix(covariates_meta_analysis, 'distal') -->
<!-- rectal <- create_suffix(covariates_meta_analysis, 'rectal') -->

<!-- knitr::include_graphics(c(paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", proximal), -->
<!--                           paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", distal), -->
<!--                           paste0(output_dir_meta, "meta_analysis_", params$exposure, "_", rectal))) -->
<!-- knitr::include_graphics(c(paste0(output_dir_meta, "funnel_plot_", params$exposure, "_", proximal), -->
<!--                           paste0(output_dir_meta, "funnel_plot_", params$exposure,  "_", distal), -->
<!--                           paste0(output_dir_meta, "funnel_plot_", params$exposure,  "_", rectal))) -->
<!-- ``` -->
